<app-sidebar></app-sidebar>
<div class="container-fluid ps-6">
  <app-dashboard-head></app-dashboard-head>
  <div class="ps-0">
    <div class="row mb-5">
      <div class="col-11">
        <h4>Leads</h4>
        <p class="page-intro">Whole data about your business here</p>
      </div>
      <!-- <div class="col-1 text-end">
        <button
          pButton
          label="Clear"
          class="btn btn-dark rounded-1"
          icon="pi pi-filter-slash"
          (click)="clear()"
        ></button>
      </div> -->
    </div>
    <div class="ps-3 mb-5">
      <input
        type="text"
        placeholder="Search by Company Name"
        [(ngModel)]="lead.companyName"
        class="order-search form-control"
        (input)="getLeadList(undefined, lead)"
      />
    </div>

    <div class="card text-nowrap">
      <p-table
        #dt1
        [value]="paginatedLeads?.content!"
        dataKey="id"
        [globalFilterFields]="['name']"
        selectionMode="single"
      >
        <ng-template pTemplate="caption">
          <div class="row">
            <div class="col-10"></div>
            <div class="col-2 text-end">
              <button
                pButton
                type="button"
                label="New"
                class="p-button-dark bg-dark"
                icon="pi pi-plus"
                (click)="showModal()"
              ></button>
            </div>
          </div>
        </ng-template>
        <ng-template pTemplate="header">
          <tr>
            <th class="col text-start">Company Name</th>
            <th class="col text-start">Contact Name</th>
            <th class="col text-start">
              <div>
                Status
                <p-columnFilter
                  field="representative"
                  matchMode="in"
                  display="menu"
                  [showMatchModes]="false"
                  [showOperator]="false"
                  [showAddButton]="false"
                >
                  <ng-template pTemplate="header">
                    <div class="px-3 pt-3 pb-0">
                      <span class="font-bold">Status</span>
                    </div>
                  </ng-template>
                  <ng-template
                    pTemplate="filter"
                    let-value
                    let-filter="filterCallback"
                  >
                    <p-dropdown
                      [ngModel]="value"
                      [options]="statusToFilter?.productFieldValuesList"
                      [(ngModel)]="lead.leadStatusType"
                      placeholder="Status"
                      optionLabel="name"
                      optionValue="name"
                      (onChange)="getLeadList(undefined, lead)"
                    >
                      <ng-template let-option pTemplate="item">
                        <div class="inline-block vertical-align-middle">
                          <span class="ml-1 mt-1">{{ option.name }}</span>
                        </div>
                      </ng-template>
                    </p-dropdown>
                  </ng-template>
                </p-columnFilter>
              </div>
            </th>
            <th class="text-end pe-5 col">
              <span class="pe-4"> Action </span>
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-lead let-i="rowIndex">
          <tr class="clickable-row text-start" (click)="edit(lead.id)">
            <td class="text-start">
              <a
                class="nav-link w-100"
                [routerLink]="['/create-lead']"
                [queryParams]="{ id: lead.id }"
                (click)="$event.stopPropagation()"
              >
                {{ lead?.companyName }}
              </a>
            </td>
            <td class="text-start">
              <a
                class="nav-link"
                [routerLink]="['/create-lead']"
                [queryParams]="{ id: lead.id }"
                (click)="$event.stopPropagation()"
              >
                {{
                  lead?.contact[0]?.name != null
                    ? lead.contact[0]?.name + "+" + (lead?.contact?.length - 1)
                    : lead.contact[1]?.name != null
                    ? lead.contact[1]?.name + "+" + (lead?.contact?.length - 2)
                    : ""
                }}
              </a>
            </td>
            <td class="text-start">
              <a
                class="nav-link"
                [routerLink]="['/create-lead']"
                [queryParams]="{ id: lead.id }"
                (click)="$event.stopPropagation()"
              >
                {{ lead?.leadStatusType }}
              </a>
            </td>
            <td class="text-end">
              <div
                class="btn-group mr-2"
                role="group"
                aria-label="Second group"
              >
                <button
                  type="button"
                  class="btn order-table-btn"
                  (click)="showModal(lead); $event.stopPropagation()"
                >
                  <i class="fa-solid fa-pen"></i>&nbsp;Edit
                </button>
                <button
                  type="button"
                  class="btn order-table-btn"
                  (click)="deleteLead(lead); $event.stopPropagation()"
                >
                  <i class="fa-solid fa-trash"></i>&nbsp;Delete
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center">No lead Found.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
    <p-paginator
      [rows]="paginatedLeads?.pageSize!"
      [totalRecords]="paginatedLeads?.totalElements!"
      (onPageChange)="getLeadList($event)"
      [rowsPerPageOptions]="[5, 10, 15]"
      currentPageReportTemplate="Showing {{
        paginatedLeads?.pageNumber! * paginatedLeads?.pageSize!
      }} to {{
        (paginatedLeads?.pageNumber! + 1) * paginatedLeads?.pageSize!
      }} of {{ paginatedLeads?.totalElements! }} entries"
      [alwaysShow]="true"
      [pageLinkSize]="5"
      [showCurrentPageReport]="true"
    ></p-paginator>
  </div>
</div>
<p-dialog
  [header]="type"
  [(visible)]="visible"
  [breakpoints]="{ '960px': '75vw' }"
  [style]="{ width: '50vw' }"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closeNewLeadModal()"
>
  <form #leadForm="ngForm" (ngSubmit)="submit()">
    <div class="container text-center">
      <div class="row my-3">
        <div class="col-12">
          <label class="add-order-label d-flex justify-content-start ms-0 mb-1"
            >Company</label
          >
          <input
            pInputText
            type="text"
            class="w-100"
            required
            name="companyName"
            (input)="getLeadListForInnerBox(lead!)"
            [(ngModel)]="companyName"
          />
        </div>
        <!-- <div class="col-6">
          <label class="add-order-label d-flex justify-content-start ms-0 mb-1"
            >Contact</label
          >
          <input
            pInputText
            type="text"
            name="contactName"
            class="w-100"
            [(ngModel)]="lead.contact[0].name"
            required
          />
        </div> -->
      </div>
      <div class="row my-3" *ngIf="leadSearchModal">
        <h6>We've identified a matching lead that already exists!</h6>
        <p-table
          [value]="searchResults"
          class="p-datatable-dark"
          selectionMode="single"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="background-color: black; color: white">Company</th>
              <th style="background-color: black; color: white">Status</th>
              <th style="background-color: black; color: white">Created</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-result>
            <tr class="clickable-row" (click)="edit(result.id)">
              <td>
                <a
                  class="nav-link w-100"
                  [routerLink]="['/create-lead']"
                  [queryParams]="{ id: lead.id }"
                  (click)="$event.stopPropagation()"
                >
                  {{ result?.companyName }}
                </a>
              </td>
              <td>
                <a
                  class="nav-link w-100"
                  [routerLink]="['/create-lead']"
                  [queryParams]="{ id: lead.id }"
                  (click)="$event.stopPropagation()"
                >
                  {{ result?.leadStatusType }}
                </a>
              </td>
              <td>
                <a
                  class="nav-link w-100"
                  [routerLink]="['/create-lead']"
                  [queryParams]="{ id: lead.id }"
                  (click)="$event.stopPropagation()"
                >
                  {{ result?.createdAt }}
                </a>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
      <div class="row d-flex justify-content-end">
        <div class="col-2">
          <button
            class="btn btn-danger w-100"
            type="button"
            (click)="closeNewLeadModal()"
          >
            Cancel
          </button>
        </div>
        <div class="col-3">
          <button
            [disabled]="!leadForm.valid || leadSearchModal"
            class="btn btn-dark w-100"
            type="submit"
          >
            {{ mode }}
          </button>
        </div>
      </div>
    </div>
  </form>
</p-dialog>
<!-- <p-dialog
  header="Leads"
  [(visible)]="leadSearchModal"
  [breakpoints]="{ '960px': '75vw' }"
  [style]="{ width: '50vw' }"
  [draggable]="false"
  [resizable]="false"
>
  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <input
          pInputText
          type="text"
          [(ngModel)]="lead.companyName"
          (input)="searchCompanyAndContactName(lead)"
          placeholder="Enter Company Name"
        />
      </div>
      <div class="col">
        <input
          pInputText
          type="text"
          [(ngModel)]="lead.contactName"
          (input)="searchCompanyAndContactName(lead)"
          placeholder="Enter Contact Name"
        />
      </div>
    </div>
  </div>
</p-dialog> -->
<p-toast></p-toast>
